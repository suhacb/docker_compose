networks:
    nutrients:

volumes:
    db:
    postgres_data:
    airflow_data:

services:
    app:
        build:
            context: ./nginx
            dockerfile: Dockerfile
        container_name: ${APP_NAME}_app
        ports:
            - "${APP_PORT}:80"
        volumes:
            - "${CODE_DIR}:${APP_DIR}"
            - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
        depends_on:
            - php
            - db
        networks:
            - ${NETWORK}
    
    db:
        image: mysql:9.4
        container_name: ${APP_NAME}_db
        platform: linux/x86_64
        restart: unless-stopped
        tty: true
        environment:
            MYSQL_DATABASE: '${MYSQL_DATABASE}'
            MYSQL_USER: '${MYSQL_USER}'
            MYSQL_PASSWORD: '${MYSQL_PASSWORD}'
            MYSQL_ROOT_PASSWORD: '${MYSQL_ROOT_PASSWORD}'
            SERVICE_TAGS: '${SERVICE_TAGS}'
            SERVICE_NAME: '${SERVICE_NAME}'
            MYSQL_ROOT_HOST: '%'
        command: ['mysqld', '--character-set-server=utf8mb4', '--collation-server=utf8mb4_slovenian_ci']
        volumes:
            - db:/var/lib/mysql
        networks:
            - ${NETWORK}

    phpmyadmin:
        image: phpmyadmin:5.2
        container_name: ${APP_NAME}_phpmyadmin
        networks:
            - ${NETWORK}
        environment:
            MYSQL_ROOT_PASSWORD: '${MYSQL_ROOT_PASSWORD}'
            MYSQL_USER: '${MYSQL_USER}'
            MYSQL_PASSWORD: '${MYSQL_PASSWORD}'
            PMA_PORT: 3306
        ports:
            - "${PHPMYADMIN_PORT}:80"
    
    php:
        build:
            context: ./php
            dockerfile: Dockerfile
            args:
                - workdir=${APP_DIR}
        container_name: ${APP_NAME}_php
        environment:
            - TIMEZONE=${TIMEZONE}
        volumes:
            - ${CODE_DIR}:${APP_DIR}
        networks:
            - ${NETWORK}

    artisan:
        build:
            context: ./php
            dockerfile: Dockerfile
            args:
                - workdir=${APP_DIR}
        container_name: ${APP_NAME}_artisan
        volumes:
            - ${CODE_DIR}:${APP_DIR}
        depends_on:
            - db
        working_dir: ${APP_DIR}
        entrypoint: ['php', '${APP_DIR}/artisan']
        networks:
            - ${NETWORK}

    airflow_postgres:
        image: postgres:15
        container_name: ${APP_NAME}_airflow_postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - ${NETWORK}
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 5s
            retries: 5

    airflow:
        image: apache/airflow:2.10.2
        container_name: ${APP_NAME}_airflow
        restart: always
        depends_on:
            airflow_postgres:
                condition: service_healthy
        environment:
            AIRFLOW__CORE__EXECUTOR: LocalExecutor
            AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${APP_NAME}_airflow_postgres:5432/${POSTGRES_DB}
            AIRFLOW__CORE__LOAD_EXAMPLES: "false"
            AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "false"
            AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
            _PIP_ADDITIONAL_REQUIREMENTS: ""
        volumes:
            - airflow_data:/opt/airflow
            - ${AIRFLOW_DIR}/dags:/opt/airflow/dags
            - ${AIRFLOW_DIR}/logs:/opt/airflow/logs
            - ${AIRFLOW_DIR}/plugins:/opt/airflow/plugins
        ports:
            - "${AIRFLOW_PORT}:8080"
        networks:
            - ${NETWORK}
        command: >
            bash -c "
                airflow db upgrade &&
                airflow users create --username ${AIRFLOW_USER} --password ${AIRFLOW_PASSWORD} --firstname Air --lastname Flow --role Admin --email admin@example.com &&
                airflow scheduler &
                exec airflow webserver
            "